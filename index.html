<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Lokasi FC MAKA</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Light Mode Variables */
      --bg-body: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #1f2937;
      --text-sec: #6b7280;
      --primary: #2563eb; 
      --accent: #06b6d4;
      --danger: #ef4444;
      --success: #22c55e;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
      --header-bg: rgba(255, 255, 255, 0.90);
    }

    /* Dark Mode Variables */
    body.dark-mode {
      --bg-body: #0f172a;
      --card-bg: #1e293b;
      --text-main: #f1f5f9;
      --text-sec: #94a3b8;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      --header-bg: rgba(15, 23, 42, 0.90);
    }

    html { height: 100%; scroll-behavior: smooth; }
    
    body{
      min-height: 100%; margin:0;
      font-family: 'Poppins', sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      transition: background 0.3s, color 0.3s;
      text-align: center;
      /* PERBAIKAN 3: Padding bawah diperbesar agar list tidak ketutup tombol SOS */
      padding-bottom: 160px; 
    }
    
    /* HEADER STICKY */
    header{
      padding: 10px 20px;
      background: var(--header-bg);
      backdrop-filter: blur(8px);
      position: sticky; top: 0; z-index: 1000;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      display: flex; flex-direction: column; align-items: center;
      transition: background 0.3s;
    }
    
    .header-row { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .logo-area { display: flex; align-items: center; gap: 10px; }
    .logo-area img{ width: 70px; height: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
    .logo-area h1{
      margin: 0; font-size: 1.1rem; font-weight: 800;
      background: -webkit-linear-gradient(45deg, var(--primary), var(--accent));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      text-align: left; line-height: 1.2;
    }

    .header-actions { display: flex; gap: 8px; }
    .icon-btn {
      background: transparent; border: 1px solid var(--text-sec); color: var(--text-main);
      width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: all 0.2s;
    }
    .icon-btn:hover { background: var(--bg-body); transform: scale(1.05); }

    #weatherWidget {
      display: none; align-items: center; justify-content: center; gap: 6px;
      background: linear-gradient(to right, #3b82f6, #06b6d4);
      color: white; padding: 6px 14px; border-radius: 20px; margin-bottom: 8px;
      font-size: 0.8rem; font-weight: 600; width: fit-content;
      animation: fadeIn 0.5s ease;
    }

    .find-btn{
      padding: 12px; width: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
      border: none; color: white; border-radius: 12px; cursor: pointer;
      font-weight: 600; font-size: 0.95rem; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
      transition: transform 0.2s;
    }
    .find-btn:active{ transform: scale(0.98); }

    /* FILTER CHIPS UPDATE */
    .filter-scroll {
      display: flex; gap: 10px; padding: 0 20px; margin: 15px 0;
      overflow-x: auto; scrollbar-width: none;
      justify-content: center; /* Tengahkan chip */
    }
    .filter-chip {
      padding: 8px 18px; border-radius: 20px; border: 1px solid var(--text-sec);
      background: var(--card-bg); color: var(--text-main); font-size: 0.85rem; font-weight: 500;
      white-space: nowrap; cursor: pointer; transition: all 0.2s; opacity: 0.7;
    }
    .filter-chip.active {
      background: var(--primary); color: white; border-color: var(--primary); 
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3); opacity: 1; font-weight: 600;
    }

    main.list-container{ display: flex; flex-direction: column; gap: 14px; padding: 0 20px; max-width: 800px; margin: 0 auto; }

    .card{
      background: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow);
      text-align: left; border: 1px solid rgba(0,0,0,0.05); opacity: 0; animation: fadeInUp 0.5s ease forwards;
      overflow: hidden; transition: background 0.3s;
    }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    
    .card summary {
      padding: 18px 20px; font-weight: 700; font-size: 1rem; cursor: pointer;
      list-style: none; display: flex; justify-content: space-between; align-items: center;
      position: relative;
    }
    .card summary::-webkit-details-marker { display: none; }

    .status-dot {
      height: 10px; width: 10px; background-color: #ccc; border-radius: 50%; display: inline-block; margin-right: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2); flex-shrink: 0;
    }
    .status-open { background-color: var(--success); box-shadow: 0 0 8px var(--success); }
    .status-closed { background-color: var(--danger); }

    .card-content { padding: 0 20px 20px 20px; border-top: 1px solid rgba(0,0,0,0.05); }
    .card-content p { margin: 8px 0; font-size: 0.9rem; color: var(--text-sec); display: flex; align-items: center; gap: 8px; }
    
    .card-actions { margin-top: 15px; display: flex; gap: 8px; width: 100%; }
    .nav-link, .report-btn, .cp-btn { 
      flex: 1; padding: 12px 5px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; 
    }
    .nav-link { background: var(--primary); color: white; }
    .report-btn { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
    .cp-btn { background: rgba(6, 182, 212, 0.1); color: var(--accent); border: 1px solid rgba(6, 182, 212, 0.3); }

    #floatingSosBtn {
      position: fixed; bottom: 90px; right: 20px; width: 55px; height: 55px;
      background: var(--danger); color: white; border: none; border-radius: 50%; font-size: 1.5rem;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5); z-index: 950; display: flex; align-items: center; justify-content: center;
      cursor: pointer; opacity: 0; pointer-events: none; transform: scale(0.5); transition: all 0.3s;
      animation: pulse 2s infinite;
    }
    #floatingSosBtn.show { opacity: 1; pointer-events: auto; transform: scale(1); }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

    #toTopBtn { position: fixed; bottom: 30px; right: 28px; width: 40px; height: 40px; background: var(--card-bg); color: var(--primary); border: 1px solid var(--text-sec); border-radius: 50%; font-size: 1.2rem; cursor: pointer; z-index: 940; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

    footer{
      position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); padding: 10px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 900; border-top: 1px solid rgba(0,0,0,0.05);
    }
    .footer-text { font-size: 0.75rem; color: var(--text-sec); margin: 2px 0; }

    #helpPanel{
      position: fixed; top: 0; right: -340px; width: 280px; height: 100%;
      background: var(--card-bg); box-shadow: -5px 0 30px rgba(0,0,0,0.2); padding: 25px; transition: right 0.3s ease; z-index: 1100; text-align: left; color: var(--text-main);
    }
    #helpPanel a { display: block; background: rgba(37, 99, 235, 0.1); color: var(--primary); padding: 12px; border-radius: 10px; margin-top: 8px; text-decoration: none; font-weight: 600; }
    
    #toastNotification { position: fixed; top: 90px; left: 50%; transform: translate(-50%, -100px); background: #333; color: white; padding: 12px 24px; border-radius: 50px; font-size: 0.9rem; z-index: 3000; opacity: 0; transition: all 0.4s; white-space: nowrap;}
    #toastNotification.show { transform: translate(-50%, 0); opacity: 1; }
    
    #welcomeOverlay{ position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 2000; }
    #welcomeBox{ background: var(--card-bg); padding: 30px; border-radius: 24px; width: 85%; max-width: 350px; text-align: center; color: var(--text-main); box-shadow: 0 20px 50px rgba(0,0,0,0.3); }

  </style>
</head>
<body>

  <header>
    <div class="header-row">
      <div class="logo-area">
        <img src="mlu-logo.png" alt="MLU" id="mluLogo" onerror="this.style.display='none';">
        <h1>Lokasi Fast Charging<br><span style="font-size:0.7em; font-weight:400; color:var(--text-sec)">MAKA</span></h1>
      </div>
      <div class="header-actions">
        <button class="icon-btn" id="themeToggle" title="Ganti Tema">üåô</button>
        <button class="icon-btn" id="helpBtnHeader" title="Bantuan">üÜò</button>
      </div>
    </div>
    
    <div id="weatherWidget">Loading...</div>
    <button class="find-btn" id="manualFindBtn">üìç Temukan Lokasi Terdekat</button>
  </header>

  <div class="filter-scroll">
    <div class="filter-chip" onclick="toggleFilter('gratis', this)">üí∏ Gratis</div>
    <div class="filter-chip" onclick="toggleFilter('24jam', this)">‚è∞ 24 Jam</div>
    <div class="filter-chip" onclick="toggleFilter('fast', this)">‚ö° Fast Only</div>
  </div>

  <div style="display:none;" id="searchContainer">
     <input type="text" id="searchBox">
  </div>

  <main class="list-container"></main>

  <button id="floatingSosBtn">üÜò</button>
  <button id="toTopBtn">‚¨ÜÔ∏è</button>

  <footer>
    <div>
      <p class="footer-text" style="font-weight:600; color:var(--primary);">Created by MLU Squad ¬© 2025</p>
      <p class="footer-text">üë§ <span id="visitorCount">...</span> Real Users</p>
    </div>
  </footer>

  <div id="helpPanel">
    <h3>Pusat Bantuan</h3>
    <p style="font-size:0.9rem; color:var(--text-sec)">Klik tombol di bawah untuk terhubung ke WhatsApp:</p>
    <div style="margin-top:15px;">
      <a href="https://wa.me/6287722285445?text=Halo%2C%20bantuan%20towing">üîß CS (Kendala Unit)</a>
      <a href="https://wa.me/6285117468556?text=Halo%2C%20info%20tagihan">üí≥ Admin Tagihan/Xendit</a>
      <a href="https://wa.me/6285281760728">üßí Akbar (RTO)</a>
      <a href="https://wa.me/6282310253644">ü•∑ Ilham (Ketum MLU)</a>
      <a href="https://wa.me/6283179721893">üö® Ogi (URC)</a>
    </div>
    <button id="closeHelp" style="margin-top:20px; width:100%; padding:10px; border:none; background:var(--bg-body); color:var(--text-main); border-radius:8px; cursor:pointer;">Tutup</button>
  </div>

  <div id="welcomeOverlay" style="display:none;">
    <div id="welcomeBox">
      <h3 style="margin-top:0;">Selamat Datang MAKA Riders</h3>
      <p>Ada yang bisa dibantu?</p>
      <button class="find-btn" id="welcomeFind" style="margin-top:10px;">üìç Cari Charger Terdekat</button>
      <button style="background:transparent; border:2px solid var(--danger); color:var(--danger); padding:12px; width:100%; border-radius:12px; margin-top:10px; font-weight:600; cursor:pointer;" id="welcomeSOS">üÜò Butuh Bantuan</button>
    </div>
  </div>

  <div id="toastNotification"></div>

  <script>
    // DATA LOKASI
    const chargers = [
      { name: "Kelapa Gading", lat: -6.171583, lng: 106.899884, link: "https://maps.app.goo.gl/TKfjDuwrEFU2tHoF9", type: "Fast", nozzles: 3, hours: "24 jam 7/7", cost: "Gratis" },
      { name: "Radio Dalam", lat: -6.262336, lng: 106.7888838, link: "https://maps.app.goo.gl/VULRCigqJ4iM8SSZ6", type: "Fast", nozzles: 3, hours: "24 jam 7/7", cost: "Gratis" },
      
      // PERBAIKAN 2: KOORDINAT BEKASI DIPERBAIKI (Dulu 106.01 [Banten] -> Jadi 106.99 [Bekasi Kota])
      { name: "Bekasi", lat: -6.223380, lng: 107.010880, link: "https://maps.app.goo.gl/4fdRXFebJHJW63Dg7", type: "Fast", nozzles: 3, hours: "24 jam 7/7", cost: "Gratis (Parkir Berbayar)" },
      
      { name: "Gading Serpong", lat: -6.246792, lng: 106.629594, link: "https://maps.app.goo.gl/j5oeATswU7J9e9jj7", type: "Fast", nozzles: 3, hours: "24 jam 7/7", cost: "Gratis (Parkir Berbayar)" },
      { name: "Depok", lat: -6.402484, lng: 106.794240, link: "https://maps.app.goo.gl/FYH2yXqo1Mgipz6R7", type: "Fast", nozzles: 3, hours: "24 jam 7/7", cost: "Gratis" },
      { name: "Marbella Kemang", lat: -6.260627, lng: 106.813746, link: "https://maps.app.goo.gl/wwzT9iLS34WFRgyi9", type: "Fast", nozzles: 3, hours: "24 jam 7/7", cost: "Gratis (Parkir berbayar)" },
      { name: "Starvo PIK", lat: -6.124106, lng: 106.739785, link: "https://maps.app.goo.gl/6c5mKecEKvGqjv3Y7", type: "Maka+", nozzles: 1, hours: "Senin‚ÄìJumat 08.00‚Äì19.00", cost: 'Menggunakan Maka+ tukar KTP (berbayar via Starvo)' },
      { name: "Starvo Kedoya", lat: -6.186334, lng: 106.766978, link: "https://maps.app.goo.gl/HSKbMPz5UrwW178V9", type: "Medium", nozzles: 1, hours: "09.00‚Äì17.00", cost: 'Berbayar (via Starvo)' },
      { name: "Ciledug", lat: -6.207012, lng: 106.714569, link: "https://maps.app.goo.gl/DSJiJyAW1BvL2Gwm8", type: "Fast", nozzles: 2, hours: "24 jam 7/7", cost: "Gratis" },
      { name: "Bintaro", lat: -6.274624, lng: 106.745262, link: "https://maps.app.goo.gl/yZNxoj2gyutxd4zJA", type: "Fast", nozzles: 2, hours: "24 jam 7/7", cost: "Gratis" },
      { name: "Motoriz Meruya", lat: -6.200132, lng: 106.737796, link: "https://maps.app.goo.gl/xLqKRsEZ9WpBpTjf9", type: "Fast", nozzles: 2, hours: "24 jam 7/7", cost: 'Berbayar (via Casan.id)' },
      { name: "Motoriz Kranggan", lat: -6.340640, lng: 106.943016, link: "https://maps.app.goo.gl/bA1248oJ5C8pUXhg9", type: "Fast", nozzles: 2, hours: "09.00‚Äì19.00 WIB", cost: 'Berbayar (via Casan.id)' },
      { name: "Warung Bu Ratna Cirendeu", lat: -6.310043, lng: 106.758325, link: "https://maps.app.goo.gl/Eyi3nNZHNMU64iYY7", type: "Fast", nozzles: 2, hours: "06.00‚Äì23.59", cost: 'Berbayar (via Casan.id)' },
      { name: "Klinik Pratama Condet", lat: -6.273896, lng: 106.857598, link: "https://maps.app.goo.gl/hTwbD4wEKB8g5qnU8?g_st=ac", type: "Fast", nozzles: 2, hours: "07.00 - 23.30", cost: 'Berbayar (via Casan.id)' },
      { name: "Mister Kong Steam Wash", lat: -6.350800, lng: 106.830000, link: "https://maps.app.goo.gl/n6nUVbQzWay6f2MG6", type: "Fast", nozzles: 2, hours: "10.00 - 22.00", cost: 'Berbayar (via Casan.id)' },
      { name: "Hotel Kartika Chandra", lat: -6.227645, lng: 106.819109, link: "https://maps.app.goo.gl/osYqkiaaebUoauxq5", type: "Fast", nozzles: 5, hours: "24 jam", cost: 'Berbayar (via Starvo)' },
      { name: "Suzuki Cengkareng", lat: -6.150602, lng: 106.727243, link: "https://maps.app.goo.gl/uy6GpcKEHUtQHoFz7?g_st", type: "Fast", nozzles: 2, hours: "24 jam 7/7", cost: 'Berbayar (via Casan.id)' },
      { name: "Dem Pro Kalimalang", lat: -6.244279, lng: 106.902554, link: "https://maps.app.goo.gl/YaQDCmQ2R5u1d4SP8", type: "Fast", nozzles: 2, hours: "24 jam 7/7", cost: 'Berbayar (via Casan.id)' },
      { name: "Trans go Matraman", lat: -6.208155, lng: 106.874669, link: "https://maps.app.goo.gl/dZD5YVGP7NHFJ8bKA", type: "Fast", nozzles: "2", hours: "08.00 - 23.00", cost: 'Berbayar (via Casan.id)', cp: "6285697279354" },
      { name: "Motoriz Sukapura", lat: -6.139714, lng: 106.922504, link: "https://maps.app.goo.gl/eePUBDDHDBXboHq4A?g_st=ipc", type: "Fast", nozzles: 2, hours: "24 jam", cost: 'Berbayar (via Casan.id)' },
      { name: "Bengkel Bubut Kemayoran", lat: -6.171770, lng: 106.853500,  link: "https://maps.app.goo.gl/ytu5Szsaq5nZGyFR8", type: "Fast", nozzles: 1, hours: "24 jam 7/7", cost: 'Berbayar (via Casan.id)' },
      { name: "Smoot Gerbang Karawaci", lat: -6.214180, lng: 106.601771,  link: "https://maps.app.goo.gl/PShi9wbBT3uGycso7", type: "Fast", nozzles: 2, hours: "24 jam 7/7", cost: 'Berbayar (via Casan.id) (Sementara masih gratis)' },
    ];

    let currentFilter = 'all';
    let userLat = null;
    let userLng = null;

    function showToast(message) {
      const toast = document.getElementById('toastNotification');
      toast.textContent = message; toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function getStatusColor(hoursString) {
        const now = new Date();
        const currentHour = now.getHours();
        const str = hoursString.toLowerCase();
        if(str.includes("24 jam")) return "status-open";
        const times = str.match(/(\d{2})[:.]\d{2}/g);
        if (times && times.length >= 2) {
            const openTime = parseInt(times[0].slice(0,2));
            const closeTime = parseInt(times[1].slice(0,2));
            if(currentHour >= openTime && currentHour < closeTime) {
                return "status-open";
            } else {
                return "status-closed";
            }
        }
        return "status-closed";
    }

    function getStatusText(statusClass) {
        return statusClass === 'status-open' ? 'Buka' : 'Tutup';
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      if(!lat1 || !lon1) return null;
      const R = 6371; 
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // --- LOGIKA FILTER TOGGLE ---
    function toggleFilter(category, element) {
        const isActive = element.classList.contains('active');
        
        // Reset semua filter visual
        document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));

        if (isActive) {
            // Jika diklik saat aktif -> Matikan filter (Show All)
            currentFilter = 'all';
        } else {
            // Jika belum aktif -> Aktifkan filter ini
            element.classList.add('active');
            currentFilter = category;
        }
        
        applyFilter();
    }

    function applyFilter() {
        let filteredList = chargers;

        if (currentFilter === 'gratis') {
            filteredList = chargers.filter(c => c.cost.toLowerCase().includes('gratis'));
        } else if (currentFilter === '24jam') {
            filteredList = chargers.filter(c => c.hours.toLowerCase().includes('24 jam'));
        } else if (currentFilter === 'fast') {
            filteredList = chargers.filter(c => c.type.toLowerCase().includes('fast'));
        }

        // Sort ulang jika user location ada
        if(userLat && userLng) {
            filteredList.sort((a, b) => (a.distance || 9999) - (b.distance || 9999));
        }

        renderCards(filteredList);
    }

    function renderCards(list) {
      const container = document.querySelector('.list-container');
      container.innerHTML = '';
      if (list.length === 0) {
          container.innerHTML = '<div style="padding:40px; opacity:0.6;">Tidak ada lokasi yang cocok.</div>';
          return;
      }
      
      list.forEach((charger, index) => {
        const card = document.createElement('details');
        card.className = 'card';
        card.style.animationDelay = (index * 50) + 'ms'; 
        
        const statusClass = getStatusColor(charger.hours);
        const statusLabel = getStatusText(statusClass);

        const reportLink = `https://wa.me/6287722285445?text=${encodeURIComponent(`Lapor: ${charger.name} bermasalah.`)}`;
        let cpBtnHTML = charger.cp ? `<a href="https://wa.me/${charger.cp}" target="_blank" class="cp-btn">üìû Hubungi</a>` : '';

        card.innerHTML = `
          <summary>
            <div style="display:flex; align-items:center; width:100%;">
                <span class="status-dot ${statusClass}" title="${statusLabel}"></span>
                <span style="flex-grow:1; text-align:left;">${charger.name}</span>
                ${charger.distance ? `<span class="card-distance">${charger.distance.toFixed(1)} km</span>` : ''}
            </div>
          </summary>
          <div class="card-content">
            <p>‚ö° <strong>${charger.type}</strong> (${charger.nozzles} nozzle)</p>
            <p>‚è∞ ${charger.hours}</p>
            <p>üíµ ${charger.cost}</p>
            <div class="card-actions">
              <a href="${charger.link}" target="_blank" class="nav-link">üìç Navigasi</a>
              <a href="${reportLink}" target="_blank" class="report-btn">‚ö†Ô∏è Lapor</a>
              ${cpBtnHTML}
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    const themeBtn = document.getElementById('themeToggle');
    themeBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        themeBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('mlu_theme', isDark ? 'dark' : 'light');
    });
    if(localStorage.getItem('mlu_theme') === 'dark'){
        document.body.classList.add('dark-mode');
        themeBtn.textContent = '‚òÄÔ∏è';
    }

    async function updateCounter() {
        try {
            const el = document.getElementById('visitorCount');
            const res = await fetch(`https://api.countapi.xyz/hit/mlu-squad-v4/visits`);
            const data = await res.json();
            el.textContent = data.value || "1";
        } catch(e) { document.getElementById('visitorCount').textContent = "‚Äî"; }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      updateCounter();
      const findBtn = document.getElementById('manualFindBtn');
      const helpPanel = document.getElementById('helpPanel');
      
      window.addEventListener('scroll', () => {
        const y = window.scrollY;
        document.getElementById('floatingSosBtn').classList.toggle('show', y > 100);
        document.getElementById('toTopBtn').style.display = y > 100 ? 'block' : 'none';
      });

      const toggleHelp = (show) => { helpPanel.style.right = show ? '0px' : '-340px'; };
      document.getElementById('helpBtnHeader').onclick = () => toggleHelp(true);
      document.getElementById('floatingSosBtn').onclick = () => toggleHelp(true);
      document.getElementById('closeHelp').onclick = () => toggleHelp(false);
      document.getElementById('welcomeSOS').onclick = () => { document.getElementById('welcomeOverlay').style.display='none'; toggleHelp(true); };

      findBtn.addEventListener('click', () => {
        if(!navigator.geolocation) return showToast("GPS tidak aktif");
        findBtn.innerHTML = '‚è≥ Mencari...';
        
        navigator.geolocation.getCurrentPosition(pos => {
            userLat = pos.coords.latitude;
            userLng = pos.coords.longitude;
            
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${userLat}&longitude=${userLng}&current_weather=true`)
             .then(r=>r.json()).then(d=>{
                const w = document.getElementById('weatherWidget');
                w.style.display = 'flex';
                if(d.current_weather) w.innerHTML = `${d.current_weather.weathercode < 3 ? '‚òÄÔ∏è' : '‚òÅÔ∏è'} ${d.current_weather.temperature}¬∞C`;
             });

            chargers.forEach(c => c.distance = getDistance(userLat, userLng, c.lat, c.lng));
            applyFilter(); 
            findBtn.innerHTML = '‚úÖ Lokasi Ditemukan';
            
        }, () => { findBtn.innerHTML = 'üìç Temukan Lokasi'; showToast("Gagal deteksi lokasi"); });
      });

      document.getElementById('toTopBtn').onclick = () => window.scrollTo({top:0});
      document.getElementById('welcomeFind').onclick = () => {
          document.getElementById('welcomeOverlay').style.display='none';
          findBtn.click();
      };

      if(!localStorage.getItem('mlu_v7')) document.getElementById('welcomeOverlay').style.display='flex';
      localStorage.setItem('mlu_v7','1');

      renderCards(chargers);
    });
  </script>
</body>
</html>
